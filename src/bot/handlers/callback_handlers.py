from telegram import Update
from telegram.ext import ContextTypes
from src.services import UserService, StreakService, MotivationalService, EmergencyService, JournalService
from src.bot.keyboards import BotKeyboards
from src.utils.helpers import get_user_info, format_streak_message
from src.utils.logger import app_logger

class CallbackHandlers:
    """Handler untuk inline keyboard callbacks"""
    
    def __init__(self):
        self.user_service = UserService()
        self.streak_service = StreakService()
        self.motivational_service = MotivationalService()
        self.emergency_service = EmergencyService()
        self.journal_service = JournalService()
    
    async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Main callback handler - routes to specific handlers"""
        query = update.callback_query
        await query.answer()
        
        callback_data = query.data
        user_info = get_user_info(query.from_user)
        
        # Log callback interaction
        app_logger.info(f"üîò Callback '{callback_data}' from user {user_info['telegram_id']} (@{user_info.get('username', 'no_username')})")
        
        # Route to appropriate handler
        if callback_data == "main_menu":
            await self._main_menu(query, context)
        elif callback_data == "check_streak":
            await self._check_streak(query, context)
        elif callback_data == "get_motivation":
            await self._get_motivation(query, context)
        elif callback_data == "emergency_mode":
            await self._emergency_mode(query, context)
        elif callback_data == "coping_tips":
            await self._coping_tips_menu(query, context)
        elif callback_data.startswith("tips_"):
            await self._handle_coping_tips(query, context, callback_data)
        elif callback_data == "education_menu":
            await self._education_menu(query, context)
        elif callback_data.startswith("edu_"):
            await self._handle_education(query, context, callback_data)
        elif callback_data == "settings_menu":
            await self._settings_menu(query, context)
        elif callback_data == "report_relapse":
            await self._report_relapse(query, context)
        elif callback_data == "confirm_relapse":
            await self._confirm_relapse(query, context)
        elif callback_data == "cancel_relapse":
            await self._cancel_relapse(query, context)
        elif callback_data.startswith("emergency_"):
            await self._handle_emergency(query, context, callback_data)
        elif callback_data == "urge_surfing":
            await self._handle_emergency(query, context, callback_data)
        elif callback_data == "trigger_analysis":
            await self._handle_emergency(query, context, callback_data)
        elif callback_data == "immediate_distraction":
            await self._handle_emergency(query, context, callback_data)
        elif callback_data == "mindfulness_protocol":
            await self._handle_emergency(query, context, callback_data)
        elif callback_data == "emergency_contacts":
            await self._handle_emergency(query, context, callback_data)
        elif callback_data == "accountability_check":
            await self._handle_emergency(query, context, callback_data)
        elif callback_data == "daily_checkin":
            await self._daily_checkin(query, context)
        elif callback_data == "journal_menu":
            await self._journal_menu(query, context)
        elif callback_data == "mood_analysis":
            await self._mood_analysis(query, context)
        elif callback_data == "trigger_journal":
            await self._trigger_analysis(query, context)
        elif callback_data.startswith("mood_"):
            await self._handle_mood_selection(query, context, callback_data)
        elif callback_data == "new_journal":
            await self._new_journal(query, context)
        elif callback_data == "read_journal":
            await self._read_journal(query, context)
        elif callback_data == "journal_save":
            await self._journal_save_callback(query, context)
        elif callback_data == "journal_cancel":
            await self._journal_cancel_callback(query, context)
        elif callback_data == "journal_edit":
            await self._journal_edit_callback(query, context)
        else:
            await query.edit_message_text("Menu tidak dikenali. Kembali ke menu utama.", 
                                        reply_markup=BotKeyboards.main_menu())
    
    async def _main_menu(self, query, context):
        """Show main menu"""
        user_info = get_user_info(query.from_user)
        user = self.user_service.get_or_create_user(**user_info)
        current_streak = self.streak_service.calculate_current_streak(user.telegram_id)
        
        message = f"""
üåü **PMO Recovery Coach AI**

Halo {user_info['first_name']}! 

üìä Current Streak: **{current_streak} hari**
üí™ Apa yang ingin kamu lakukan hari ini?

Pilih menu di bawah:
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.main_menu(),
            parse_mode='Markdown'
        )
    
    async def _check_streak(self, query, context):
        """Handle check streak callback"""
        user_info = get_user_info(query.from_user)
        user = self.user_service.get_or_create_user(**user_info)
        
        current_streak = self.streak_service.calculate_current_streak(user.telegram_id)
        stats = self.streak_service.get_streak_stats(user.telegram_id)
        milestones = self.streak_service.get_streak_milestones(current_streak)
        
        message = format_streak_message(current_streak, stats, milestones)
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.back_to_main(),
            parse_mode='Markdown'
        )
    
    async def _get_motivation(self, query, context):
        """Handle get motivation callback"""
        user_info = get_user_info(query.from_user)
        user = self.user_service.get_user(user_info['telegram_id'])
        
        quote = self.motivational_service.get_daily_quote()
        
        if user:
            current_streak = self.streak_service.calculate_current_streak(user.telegram_id)
            encouragement = self.motivational_service.get_streak_encouragement(current_streak)
        else:
            encouragement = "üåü Setiap journey dimulai dari langkah pertama!"
        
        message = f"""
üí™ **Daily Motivation**

"{quote['text']}"
*- {quote['author']}*

{encouragement}

Remember: Kamu lebih kuat dari yang kamu kira! üî•
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.back_to_main(),
            parse_mode='Markdown'
        )
    
    async def _emergency_mode(self, query, context):
        """Handle emergency mode callback"""
        message = """
üÜò **EMERGENCY MODE ACTIVATED** üÜò

**‚ö†Ô∏è SITUASI DARURAT PMO RECOVERY**

Kamu sedang mengalami urge atau craving yang kuat. TARIK NAPAS dan ikuti protokol emergency ini:

**üö® IMMEDIATE RESPONSE (0-2 menit):**
1. **STOP** - Hentikan semua aktivitas sekarang
2. **BREATHE** - Tarik napas dalam 4 detik, tahan 4 detik, buang 4 detik
3. **MOVE** - Tinggalkan lokasi/posisi sekarang juga
4. **DISTRACT** - Alihkan perhatian dengan aktivitas fisik

**üî• Ingat: Urge akan berlalu dalam 15-20 menit!**

**üì± PROTOKOL EMERGENCY OPTIONS:**

üåä **Urge Surfing** - Teknik surf the urge tanpa melawan
üéØ **Trigger Analysis** - Identify immediate triggers
üí® **Immediate Distraction** - Quick distraction techniques  
üßò **Mindfulness Protocol** - Emergency mindfulness practice
üÜò **Emergency Contacts** - Connect dengan support system
üí¨ **Accountability Check** - Report dan get support

**üí° QUICK REMINDERS:**
‚Ä¢ Kamu sudah berhasil melewati urge sebelumnya
‚Ä¢ Recovery is a journey, not perfection
‚Ä¢ Setiap detik yang kamu tahan adalah kemenangan
‚Ä¢ Your future self will thank you

**Pilih protokol yang paling sesuai dengan situasi kamu sekarang:**
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.emergency_menu(),
            parse_mode='Markdown'
        )
    
    async def _coping_tips_menu(self, query, context):
        """Handle coping tips menu"""
        message = """
üéØ **Coping Strategies**

Pilih kategori tips yang ingin kamu pelajari:

**Physical** - Aktivitas fisik untuk mengalihkan energi
**Mental** - Teknik mental dan cognitive strategies  
**Distraction** - Pengalihan perhatian yang efektif
**Mindfulness** - Teknik mindfulness dan meditation
**Productive** - Channel energi ke aktivitas produktif

Atau pilih **Random Tip** untuk mendapat strategi acak!
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.coping_tips_menu(),
            parse_mode='Markdown'
        )
    
    async def _handle_coping_tips(self, query, context, callback_data):
        """Handle specific coping tips"""
        category_map = {
            "tips_physical": "physical",
            "tips_mental": "mental", 
            "tips_distraction": "distraction",
            "tips_mindfulness": "mindfulness",
            "tips_productive": "productive",
            "tips_random": None
        }
        
        category = category_map.get(callback_data)
        tip = self.motivational_service.get_coping_tip(category)
        
        message = f"""
üéØ **{tip['title']}**

**Kategori:** {tip['category'].title()}
**Durasi:** {tip['duration']}

**Cara melakukan:**
{tip['description']}

**Pro Tip:** Konsistensi lebih penting dari perfection. Coba technique ini setiap kali urge datang untuk membangun new neural pathways!
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.back_to_main(),
            parse_mode='Markdown'
        )
    
    async def _education_menu(self, query, context):
        """Handle education menu"""
        message = """
üìö **Recovery Education Center**

Belajar tentang science di balik PMO recovery:

**üß† Dopamine & Recovery** - Bagaimana dopamine bekerja dan recovery process

**‚ú® Benefits NoFap** - Manfaat yang dilaporkan oleh banyak orang

**üîÑ Neuroplasticity** - Bagaimana otak bisa berubah dan heal

**üìà Recovery Timeline** - Apa yang diharapkan dalam timeline recovery

Knowledge is power! Semakin kamu understand prosesnya, semakin mudah untuk tetap motivated.
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.education_menu(),
            parse_mode='Markdown'
        )
    
    async def _handle_education(self, query, context, callback_data):
        """Handle education content"""
        topic_map = {
            "edu_dopamine": "dopamine",
            "edu_benefits": "benefits",
            "edu_neuroplasticity": "neuroplasticity",
            "edu_timeline": "general"
        }
        
        topic = topic_map.get(callback_data, "general")
        content = self.motivational_service.get_educational_content(topic)
        
        message = f"""
{content['title']}

{content['content']}

Remember: Understanding the process helps you stay committed to recovery! üí™
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.back_to_main(),
            parse_mode='Markdown'
        )
    
    async def _settings_menu(self, query, context):
        """Handle settings menu"""
        message = """
‚öôÔ∏è **Settings & Preferences**

**üîî Reminder Settings** - Atur daily reminders
**üåç Timezone** - Set timezone untuk accurate tracking
**üìä Lihat Stats** - Detailed recovery statistics  
**üóëÔ∏è Reset Data** - Reset semua data (permanent!)

Atur preferences sesuai kebutuhanmu untuk experience yang optimal.
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.settings_menu(),
            parse_mode='Markdown'
        )
    
    async def _report_relapse(self, query, context):
        """Handle report relapse"""
        message = """
üíô **Relapse Report**

Saya memahami betapa sulitnya moment ini. Yang penting adalah kamu honest dan mau bangkit lagi.

Apakah kamu yakin ingin melaporkan relapse?

**Yang akan terjadi:**
‚Ä¢ Streak akan di-reset ke 0  
‚Ä¢ Data tersimpan untuk learning
‚Ä¢ Kamu dapat support dan guidance
‚Ä¢ Journey baru dimulai hari ini

Relapse adalah bagian dari recovery journey bagi banyak orang. Yang penting adalah bangkit dan belajar! üí™
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.relapse_confirmation(),
            parse_mode='Markdown'
        )
    
    async def _confirm_relapse(self, query, context):
        """Handle confirm relapse"""
        user_info = get_user_info(query.from_user)
        user = self.user_service.get_user(user_info['telegram_id'])
        
        if user:
            # Record the relapse
            success = self.streak_service.record_relapse(user.telegram_id)
            
            if success:
                support_message = self.motivational_service.get_relapse_support()
                
                message = f"""
üíô **Relapse Recorded**

{support_message}

**New Journey Starts Now:**
‚Ä¢ Streak reset to 0 days
‚Ä¢ Learn from this experience  
‚Ä¢ Identify triggers and patterns
‚Ä¢ Strengthen your strategy
‚Ä¢ You're stronger than before

**Next Steps:**
1. Don't dwell on guilt - focus forward
2. Analyze what led to this moment  
3. Adjust your prevention strategy
4. Get back to healthy routines
5. Use this bot for daily support

Tomorrow is a new day. You've got this! üåÖ
                """
                
                await query.edit_message_text(
                    message,
                    reply_markup=BotKeyboards.main_menu(),
                    parse_mode='Markdown'
                )
            else:
                await query.edit_message_text(
                    "Terjadi error. Silakan coba lagi atau hubungi support.",
                    reply_markup=BotKeyboards.main_menu()
                )
        else:
            await query.edit_message_text(
                "User tidak ditemukan. Gunakan /start untuk register.",
                reply_markup=BotKeyboards.main_menu()
            )
    
    async def _cancel_relapse(self, query, context):
        """Handle cancel relapse"""
        message = """
üí™ **That's the Spirit!**

Bagus! Kamu masih kuat dan belum menyerah!

**Keep Fighting:**
‚Ä¢ Gunakan coping strategies
‚Ä¢ Alihkan perhatian ke aktivitas positif
‚Ä¢ Remember your why
‚Ä¢ Take it one hour at a time

Kamu sudah membuktikan mental strength dengan tidak melaporkan false relapse. Keep that energy! üî•
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.main_menu(),
            parse_mode='Markdown'
        )
    
    async def _handle_emergency(self, query, context, callback_data):
        """Handle emergency protocols"""
        if callback_data == "urge_surfing":
            guide = self.emergency_service.get_urge_surfing_guide()
            
            steps_text = "\n".join([
                f"**Step {step['step']}: {step['instruction']}**\n{step['detail']}"
                for step in guide['steps']
            ])
            
            key_points = "\n".join([f"‚Ä¢ {point}" for point in guide['key_points']])
            
            message = f"""
üåä **URGE SURFING PROTOCOL - EMERGENCY GUIDE**

**üèÑ‚Äç‚ôÇÔ∏è Apa itu Urge Surfing?**
Urge surfing adalah teknik mindfulness untuk 'menunggangi' gelombang urge tanpa melawan atau menyerah. Seperti surfer menunggangi ombak, kamu observe urge sampai reda sendiri.

**üß† Mengapa Efektif?**
‚Ä¢ Urge memiliki siklus alami (naik-puncak-turun) dalam 15-20 menit
‚Ä¢ Melawan urge malah memperkuat (ironic process theory)  
‚Ä¢ Acceptance mengurangi kekuatan urge

**üèÑ‚Äç‚ôÇÔ∏è LANGKAH URGE SURFING:**

**1. ACKNOWLEDGE (0-2 menit)**
"Aku sedang mengalami urge. Ini normal dalam recovery."
‚Ä¢ Jangan panic atau judge diri sendiri
‚Ä¢ Recognize: ini hanya temporary feeling

**2. OBSERVE SENSATIONS (2-5 menit)**  
‚Ä¢ Dimana kamu merasakan urge di tubuh?
‚Ä¢ Apakah ada tension, heat, tingling?
‚Ä¢ Notice rhythm atau pulsing-nya

**3. BREATHE & SURF (5-15 menit)**
‚Ä¢ Napas dalam dan slow
‚Ä¢ Bayangkan urge sebagai gelombang
‚Ä¢ Kamu adalah surfer di atas papan
‚Ä¢ Ride the wave, don't fight it

**4. WAIT & WATCH (15-20 menit)**
‚Ä¢ Watch intensity naik turun
‚Ä¢ Notice peak, then natural decrease
‚Ä¢ Stay curious, not judgmental

Remember: Urges are like waves - they rise, peak, and fall. Ride them out! üåä
            """
        
        elif callback_data == "trigger_analysis":
            message = """
üéØ **EMERGENCY TRIGGER ANALYSIS**

**‚ö†Ô∏è SITUASI DARURAT - TRIGGER IDENTIFICATION**

**üîç IMMEDIATE ASSESSMENT - ASK YOURSELF:**
1. **Dimana kamu sekarang?** (lokasi, ruangan, posisi)
2. **Jam berapa ini terjadi?** (time pattern awareness)
3. **Apa yang kamu lakukan sebelumnya?** (aktivitas trigger)
4. **Bagaimana mood kamu?** (emotional state)
5. **Apakah kamu sendiri?** (social context)

**üìä COMMON TRIGGER CATEGORIES:**

**üè† ENVIRONMENTAL TRIGGERS:**
‚Ä¢ Kamar sendirian, rumah kosong
‚Ä¢ Device/gadget dengan internet access
‚Ä¢ Tempat tidur, kamar mandi private
‚Ä¢ Waktu tertentu (malam, weekend, boring moments)

**üòî EMOTIONAL TRIGGERS:**
‚Ä¢ Stress, boredom, loneliness, anxiety
‚Ä¢ Depression, overwhelm, frustration
‚Ä¢ Low self-esteem, shame, anger
‚Ä¢ Celebration atau sadness extremes

**üíª DIGITAL TRIGGERS:**
‚Ä¢ Social media scrolling tanpa tujuan
‚Ä¢ Random browsing, "harmless" content
‚Ä¢ Gaming, streaming platforms
‚Ä¢ Accidental exposure ke triggering content

**üß† MENTAL TRIGGERS:**
‚Ä¢ Fantasy, daydreaming, nostalgia
‚Ä¢ "Just one peek" rationalization thoughts
‚Ä¢ Testing willpower atau curiosity
‚Ä¢ Bargaining dengan diri sendiri

**‚ö° EMERGENCY ACTION PLAN:**

**RIGHT NOW:**
1. **Name it:** "I'm triggered by [specific trigger]"
2. **Remove it:** Leave/close/change immediately
3. **Replace:** 20 push-ups, cold shower, call friend
4. **Protect:** Block, move public, tell someone

**üìù FOR FUTURE PREVENTION:**
‚Ä¢ Journal this trigger pattern recognition
‚Ä¢ Create specific counter-plan for this trigger
‚Ä¢ Modify environment to reduce exposure opportunities
‚Ä¢ Build stronger defenses dan early warning systems

**üéØ REMEMBER:** Every trigger identified = growth opportunity!
            """
        
        elif callback_data == "emergency_contacts":
            message = """
üÜò **EMERGENCY SUPPORT CONTACTS**

**üî• IMMEDIATE SUPPORT - REACH OUT NOW:**

**üí¨ PERSONAL SUPPORT (TEXT/CALL):**
‚Ä¢ Accountability partner atau recovery buddy
‚Ä¢ Trusted friend atau family member  
‚Ä¢ Mentor, coach, atau counselor
‚Ä¢ Someone who knows your recovery journey

**üì± PMO RECOVERY COMMUNITIES (24/7):**
‚Ä¢ Reddit: r/NoFap, r/pornfree (active community)
‚Ä¢ Discord recovery servers (real-time chat)
‚Ä¢ Facebook support groups (private groups)
‚Ä¢ Recovery apps with community features

**üáÆüá© INDONESIA CRISIS HOTLINES (24/7):**
‚Ä¢ **SEJIWA (Suicide Prevention):** 119 ext 8
‚Ä¢ **Halo Kemkes (Health Ministry):** 1500-567  
‚Ä¢ **IBUNDA (Crisis Support):** 0800-1-696-969
‚Ä¢ **Yayasan Pulih (Mental Health):** 021-788-42580

**üåç INTERNATIONAL SUPPORT:**
‚Ä¢ **Crisis Text Line:** Text HOME to 741741
‚Ä¢ **SAMHSA National Helpline:** 1-800-662-4357
‚Ä¢ **Lifeline:** 988 (US) atau local emergency number

**üíª ONLINE IMMEDIATE HELP:**
‚Ä¢ 7cups.com - Anonymous emotional support
‚Ä¢ BetterHelp crisis chat feature
‚Ä¢ Recovery forums active 24/7
‚Ä¢ PMO recovery Discord communities

**üìù SCRIPT FOR REACHING OUT:**
"Hi, I'm having a tough moment in my recovery and could use some support. Can we talk for a few minutes?"

**ü§ù ACCOUNTABILITY MESSAGE TEMPLATE:**
"I'm experiencing strong urges right now. I'm reaching out instead of acting on them. Can you help remind me why this recovery matters to me?"

**üí° REMEMBER - REACHING OUT IS STRENGTH:**
‚Ä¢ Most people WANT to help when asked directly
‚Ä¢ 5-minute conversation can completely change trajectory
‚Ä¢ You've probably helped others too - let them return favor
‚Ä¢ Building support network is part of recovery

**üèÜ AFTER GETTING SUPPORT:**
‚Ä¢ Thank them for being available
‚Ä¢ Update them later on your progress
‚Ä¢ Offer to be there for them too
‚Ä¢ Strengthen the relationship for future

üö® **IF IN MENTAL HEALTH CRISIS:** Don't hesitate to contact professional help immediately.

Your life and wellbeing matter more than anything else! üíô
            """
        
        elif callback_data == "immediate_distraction":
            message = """
üí® **IMMEDIATE DISTRACTION PROTOCOL**

**üö® EMERGENCY DISTRACTION - ACT NOW!**

**‚ö° 0-2 MENIT (IMMEDIATE ACTION):**
1. **STAND UP** - Get vertical immediately (disrupts thought pattern)
2. **LEAVE LOCATION** - Exit current room/position now
3. **INTENSE MOVEMENT** - 20 jumping jacks atau run in place
4. **COLD SHOCK** - Splash cold water on face/drink ice water

**üí™ 2-5 MENIT (PHYSICAL ENGAGEMENT):**
‚Ä¢ **Push-ups** - Do as many as you can (exhaustion stops urges)
‚Ä¢ **Squats/Burpees** - 30 quick reps (intense physical activity)
‚Ä¢ **Cold shower** - 2-3 minutes minimum (shock to system)
‚Ä¢ **Run outside** - Around block atau in place if needed

**üéµ 5-10 MENIT (SENSORY OVERLOAD):**
‚Ä¢ **Loud energetic music** - Motivational/pump up songs
‚Ä¢ **Call someone immediately** - Friend, family, accountability partner
‚Ä¢ **Educational content** - Motivational podcast/YouTube
‚Ä¢ **Sing/dance aggressively** - Engage multiple senses

**üéÆ 10-15 MENIT (MENTAL ENGAGEMENT):**
‚Ä¢ **Action videogames** - NOT browser-based (console/mobile)
‚Ä¢ **Active hobbies** - Guitar, drawing, cooking, reading
‚Ä¢ **Cleaning/organizing** - Physical environment improvement
‚Ä¢ **Learn new skill** - Tutorial, language, instrument practice

**üß† DISTRACTION SCIENCE WHY IT WORKS:**
‚Ä¢ Brain can only intensely focus on one thing at a time
‚Ä¢ Physical activity rapidly changes brain chemistry (endorphins)
‚Ä¢ Cold exposure triggers alertness and mental clarity
‚Ä¢ Social connection releases oxytocin (bonding hormone)

**‚è∞ SURVIVAL TIME GOAL:** First 15-20 minutes are critical!

**üèÜ SUCCESS REMINDER:** Every urge you resist makes the next one significantly easier to handle!
            """
            
        elif callback_data == "mindfulness_protocol":
            message = """
üßò **EMERGENCY MINDFULNESS PROTOCOL**

**üéØ MINDFUL EMERGENCY INTERVENTION**

**üí∫ SETUP (1 minute):**
‚Ä¢ Find alert sitting position (NOT lying down)
‚Ä¢ Both feet on floor, hands on knees
‚Ä¢ Spine straight but relaxed
‚Ä¢ Set timer 10-15 minutes if available

**üëÅÔ∏è STEP 1: AWARENESS (3 minutes)**
‚Ä¢ Notice: "I am having urge right now"
‚Ä¢ Observe without judgment: "This is what urge feels like"  
‚Ä¢ Remember: "I am NOT my urges, I am the observer"

**ü´Å STEP 2: BREATHING ANCHOR (5 minutes)**
‚Ä¢ **Box Breathing:** In 4 counts ‚Üí Hold 4 ‚Üí Out 4 ‚Üí Hold 4
‚Ä¢ Feel breath in nostrils, chest expansion, belly rise
‚Ä¢ When mind wanders to urge, gently return to breath
‚Ä¢ Mental mantra: "Breathing in calm, breathing out urge"

**üåä STEP 3: URGE OBSERVATION (5 minutes)**
‚Ä¢ Where exactly do you feel urge in your body?
‚Ä¢ Is sensation hot/cold, tight/loose, moving/still?
‚Ä¢ Rate intensity 1-10, watch it naturally change
‚Ä¢ Don't try to change it, just witness with curiosity

**üí≠ STEP 4: THOUGHT WATCHING (3 minutes)**
‚Ä¢ Notice urge-related thoughts arising
‚Ä¢ Label them: "Urge thought," "Rationalization," "Fantasy"
‚Ä¢ Don't engage with or fight the thoughts
‚Ä¢ Let them pass like clouds across sky

**üí™ STEP 5: VALUES RECONNECTION (2 minutes)**
‚Ä¢ Why did you start PMO recovery journey?
‚Ä¢ What kind of person do you want to become?
‚Ä¢ How will you feel about yourself if you stay strong?
‚Ä¢ Connect deeply with your higher purpose

**üåü MINDFULNESS MANTRAS:**
‚Ä¢ "This too shall pass naturally"
‚Ä¢ "I am not my urges or thoughts" 
‚Ä¢ "I choose my response consciously"
‚Ä¢ "Present moment awareness is power"

**üß† THE NEUROSCIENCE:**
‚Ä¢ Increases prefrontal cortex activity (self-control center)
‚Ä¢ Decreases amygdala reactivity (emotional overwhelm)
‚Ä¢ Creates space between stimulus and automatic response
‚Ä¢ Builds long-term resilience and emotional regulation

**‚ú® POST-SESSION:** Rate urge intensity before/after. Notice any decrease? Either way, you practiced not acting = SUCCESS!
            """
            
        elif callback_data == "accountability_check":
            message = """
üí¨ **EMERGENCY ACCOUNTABILITY CHECK**

**üéØ IMMEDIATE SELF-ACCOUNTABILITY PROTOCOL**

**üìã REALITY CHECK - ASK YOURSELF:**
1. **Current streak:** How many days clean am I?
2. **1-hour future:** How will I feel if I relapse right now?
3. **Original reasons:** Why did I start recovery?
4. **Important people:** Who am I doing this for?
5. **Progress lost:** What will I lose if I give in?

**üí™ STRENGTH EVIDENCE REVIEW:**
‚Ä¢ You've already resisted urges successfully before
‚Ä¢ Every day clean is PROOF of your inner strength
‚Ä¢ You chose recovery for important, valid reasons
‚Ä¢ You're measurably stronger now than when you started

**üìä PROGRESS ACKNOWLEDGMENT:**
‚Ä¢ Count your streak days - that's REAL measurable progress
‚Ä¢ Remember challenges you've already successfully overcome
‚Ä¢ Compare how you feel now vs when you first started
‚Ä¢ Notice concrete improvements in your life since quitting

**üéØ GOAL RECONNECTION:**
‚Ä¢ **Today:** Just make it through right now, this moment
‚Ä¢ **This week:** Reach next weekly milestone confidently
‚Ä¢ **This month:** 30/60/90 day targets (major milestones)
‚Ä¢ **Life vision:** Person you're becoming, future relationships

**üíî RELAPSE REALITY (if you give in now):**
‚Ä¢ Streak immediately resets to 0
‚Ä¢ Intense guilt, shame, disappointment cascade
‚Ä¢ Must restart entire recovery process from beginning
‚Ä¢ Lose momentum and hard-earned confidence
‚Ä¢ Reinforce neural pathways you're trying to break

**üèÜ STAYING STRONG REALITY (if you resist now):**
‚Ä¢ Streak continues growing and compounds
‚Ä¢ Pride, accomplishment, self-respect feelings
‚Ä¢ Momentum builds exponentially toward next milestone
‚Ä¢ Confidence in ability increases dramatically
‚Ä¢ Reinforce healthy neural pathway development

**üî• ACCOUNTABILITY MANTRAS:**
‚Ä¢ "I am accountable to my future self"
‚Ä¢ "My commitments to myself matter most"
‚Ä¢ "I honor my word and build integrity"
‚Ä¢ "I am actively becoming who I want to be"

**üéâ CELEBRATE THIS MOMENT:** 
You're doing accountability check instead of relapsing - that shows incredible growth and self-awareness already!
            """
        
        else:
            # Fallback for any other emergency protocols
            message = """
üö® **EMERGENCY SUPPORT ACTIVATED**

**‚ö†Ô∏è YOU'RE IN EMERGENCY MODE**
Kamu sedang mengalami situasi darurat dalam recovery. Ini NORMAL dan kamu absolutely pasti bisa melewatinya!

**üö® IMMEDIATE EMERGENCY ACTIONS:**
1. **BREATHE DEEPLY** - 3 slow, deep breaths right now
2. **CHANGE LOCATION** - Leave where you are immediately  
3. **PHYSICAL MOVEMENT** - Do jumping jacks, push-ups, cold shower
4. **REACH OUT** - Contact support system, accountability partner

**üí™ EMERGENCY REMINDERS:**
‚Ä¢ This urge WILL pass (average 15-20 minutes)
‚Ä¢ You've survived urges before and gotten stronger
‚Ä¢ Every moment you resist is building your recovery muscle
‚Ä¢ Your future self will thank you for staying strong

**üì± QUICK ACCESS:**
Use emergency menu buttons for specific protocols:
‚Ä¢ üåä Urge Surfing - Mindful observation technique
‚Ä¢ üéØ Trigger Analysis - Identify what triggered this
‚Ä¢ üí® Immediate Distraction - Physical intervention methods
‚Ä¢ üßò Mindfulness Protocol - Calm, centered approach
‚Ä¢ üÜò Emergency Contacts - Reach out for human support
‚Ä¢ üí¨ Accountability Check - Reconnect with your why

**üèÜ YOU'VE GOT THIS!** Choose your emergency protocol below.
            """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.emergency_protocol_menu(),
            parse_mode='Markdown'
        )
    
    async def _daily_checkin(self, query, context):
        """Handle daily check-in"""
        message = """
üìù **Daily Check-in**

Bagaimana perasaanmu hari ini?

Rate mood kamu dari 1-5:
1 = Sangat buruk, 5 = Sangat baik

Pilih angka di bawah:
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.mood_scale(),
            parse_mode='Markdown'
        )
    
    async def _journal_menu(self, query, context):
        """Handle journal menu"""
        message = """
üìñ **Personal Journal System**

**Apa itu Journal Feature?**
Journal adalah tools powerful untuk self-reflection dan progress tracking dalam recovery journey. Fitur ini membantu build self-awareness dan emotional intelligence.

**üéØ Manfaat Journaling:**
‚Ä¢ **Self-Awareness** - Understand thoughts, feelings, dan behaviors
‚Ä¢ **Progress Tracking** - Monitor growth dan improvement over time
‚Ä¢ **Trigger Identification** - Recognize patterns dan warning signs
‚Ä¢ **Emotional Processing** - Safe space untuk express dan work through feelings
‚Ä¢ **Goal Setting** - Clarify objectives dan track achievements
‚Ä¢ **Stress Relief** - Therapeutic outlet untuk mental health

**üìù Available Features:**

**‚úçÔ∏è Tulis Entry Baru** - Write personal reflections, thoughts, feelings, daily experiences. Include mood, challenges, victories, goals.

**üìñ Baca Entries** - Review past entries to see progress dan patterns (Coming Soon)

**üéØ Analisis Mood** - AI-powered mood pattern analysis dari entries (Coming Soon)

**üîç Analisis Trigger** - Identify triggers dan risk factors dari journal content (Coming Soon)

**üí° Journaling Tips:**
‚Ä¢ Write consistently, even if just few sentences
‚Ä¢ Be honest dan authentic dalam expression
‚Ä¢ Include both challenges dan positive moments
‚Ä¢ Note triggers, coping strategies, dan lessons learned
‚Ä¢ Set intentions atau goals untuk future

Start dengan "‚úçÔ∏è Tulis Entry Baru" untuk begin your journaling journey!
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.journal_menu(),
            parse_mode='Markdown'
        )
    
    async def _handle_mood_selection(self, query, context, callback_data):
        """Handle mood selection from daily check-in"""
        # Extract mood value from callback_data (mood_1, mood_2, etc.)
        mood_value = int(callback_data.split("_")[1])
        
        user_info = get_user_info(query.from_user)
        user = self.user_service.get_or_create_user(**user_info)
        
        # Create mood descriptions
        mood_descriptions = {
            1: "üò¢ Sangat buruk",
            2: "üòî Kurang baik", 
            3: "üòê Netral",
            4: "üòä Baik",
            5: "üòÑ Sangat baik"
        }
        
        mood_desc = mood_descriptions.get(mood_value, "Unknown")
        
        # Save mood data (you can extend this to save to database)
        # For now, just show confirmation and encouragement
        
        if mood_value <= 2:
            # Low mood - provide extra support
            message = f"""
üìù **Check-in Completed**

Mood hari ini: {mood_desc} ({mood_value}/5)

Saya melihat kamu sedang merasa kurang baik hari ini. Itu normal dan ok! üíô

ü§ó **Tips untuk hari ini:**
‚Ä¢ Ingat bahwa perasaan ini temporary
‚Ä¢ Coba lakukan satu hal kecil yang membuatmu senang
‚Ä¢ Reach out ke teman atau keluarga
‚Ä¢ Consider light exercise atau jalan-jalan

üí™ **Remember:** Bad days tidak menghapus progress yang sudah kamu buat!

Butuh bantuan lebih? Gunakan Mode Darurat di menu utama.
            """
        elif mood_value == 3:
            # Neutral mood
            message = f"""
üìù **Check-in Completed**

Mood hari ini: {mood_desc} ({mood_value}/5)

Hari yang cukup netral! Sometimes that's exactly what we need. üòå

üéØ **Suggestion untuk hari ini:**
‚Ä¢ Coba satu aktivitas yang biasanya kamu enjoy
‚Ä¢ Set small achievable goal untuk sisa hari
‚Ä¢ Practice gratitude - list 3 hal yang kamu syukuri

Keep going, you're doing great! üí™
            """
        else:
            # Good mood
            message = f"""
üìù **Check-in Completed**

Mood hari ini: {mood_desc} ({mood_value}/5)

Wonderful! Senang mendengar kamu merasa baik hari ini! üåü

‚ú® **Cara maintain good mood:**
‚Ä¢ Share positivity dengan orang lain
‚Ä¢ Gunakan energi ini untuk productive activities
‚Ä¢ Reflect on apa yang membuat hari ini special
‚Ä¢ Set intention untuk besok

Keep up the great work! You're thriving! üöÄ
            """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.back_to_main(),
            parse_mode='Markdown'
        )
    
    async def _new_journal(self, query, context):
        """Handle new journal entry - set user state for text input"""
        
        # Set user state to expect journal input
        context.user_data['state'] = 'input_journal'
        context.user_data['journal_step'] = 'waiting_for_text'
        
        # Log state change
        user_info = get_user_info(query.from_user)
        app_logger.info(f"üìù User {user_info['telegram_id']} entered journal input mode (state: input_journal)")
        
        message = """
üìù **Tulis Entry Journal Baru**

**üéØ Status: Menunggu Input Journal** 

Bot sekarang siap menerima entry journal dari kamu. Ketik pesan berikutnya sebagai journal entry.

**üí° Apa yang bisa kamu tulis:**
‚Ä¢ **Perasaan hari ini** - Bagaimana mood dan emotional state
‚Ä¢ **Events & experiences** - Apa yang terjadi hari ini  
‚Ä¢ **Challenges** - Difficulties atau struggles yang dihadapi
‚Ä¢ **Victories** - Achievements atau positive moments
‚Ä¢ **Triggers** - Situasi yang challenging untuk recovery
‚Ä¢ **Coping strategies** - Techniques yang kamu gunakan
‚Ä¢ **Gratitude** - Hal-hal yang kamu syukuri
‚Ä¢ **Goals & intentions** - Plans untuk besok atau future
‚Ä¢ **Reflections** - Insights atau lessons learned

**‚úçÔ∏è Tips untuk effective journaling:**
‚Ä¢ Write dari hati, be honest dan authentic
‚Ä¢ Include both positive dan challenging aspects
‚Ä¢ Mention specific events, feelings, dan thoughts
‚Ä¢ Note any patterns atau insights
‚Ä¢ Set intentions atau goals untuk moving forward
‚Ä¢ Aim untuk minimal 10 karakter untuk meaningful reflection

**üìù Format bebas** - tulis natural seperti diary personal.

**Contoh entry:**
"Hari ini cukup challenging karena stress di kantor, tapi saya berhasil manage dengan breathing exercises. Mood sekitar 3/5. Grateful untuk support dari keluarga. Besok ingin focus pada morning routine yang lebih konsisten."

**‚å®Ô∏è Ketik entry journal kamu sekarang dan tekan Enter!** ‚¨áÔ∏è
        """
        
        await query.edit_message_text(
            message,
            parse_mode='Markdown'
        )
    
    async def _read_journal(self, query, context):
        """Handle read journal entries"""
        user_info = get_user_info(query.from_user)
        user = self.user_service.get_or_create_user(**user_info)
        
        # Get recent entries from database
        entries = self.journal_service.get_user_entries(user.telegram_id, limit=5)
        stats = self.journal_service.get_entry_stats(user.telegram_id)
        
        if not entries:
            message = """
üìñ **Baca Journal Entries**

**Belum ada journal entries!** ÔøΩ

Kamu belum menulis journal entry apapun. Mari mulai journaling journey!

**üéØ Get Started:**
‚Ä¢ Klik "‚úçÔ∏è Tulis Entry Baru" untuk start
‚Ä¢ Write about perasaan, thoughts, experiences hari ini
‚Ä¢ Build habit journaling untuk maximum benefit

**üí° Benefits dari regular journaling:**
‚Ä¢ Self-awareness dan emotional intelligence
‚Ä¢ Progress tracking dalam recovery journey
‚Ä¢ Trigger identification dan pattern recognition
‚Ä¢ Therapeutic outlet untuk stress relief

Start writing your first entry today! ‚úçÔ∏è
            """
        else:
            # Format recent entries
            entries_text = ""
            for i, entry in enumerate(entries, 1):
                date_str = entry.created_at.strftime("%d/%m/%Y %H:%M")
                preview = entry.entry_text[:100] + "..." if len(entry.entry_text) > 100 else entry.entry_text
                entries_text += f"\n**{i}. {date_str}**\n{preview}\n"
            
            message = f"""
üìñ **Your Journal Entries**

**üìä Journal Statistics:**
‚Ä¢ **Total entries:** {stats.get('total_entries', 0)}
‚Ä¢ **Total words:** {stats.get('total_words', 0):,}
‚Ä¢ **Average words per entry:** {stats.get('average_words', 0)}
‚Ä¢ **First entry:** {stats.get('first_entry').strftime('%d/%m/%Y') if stats.get('first_entry') else 'N/A'}
‚Ä¢ **Last entry:** {stats.get('last_entry').strftime('%d/%m/%Y') if stats.get('last_entry') else 'N/A'}

**ÔøΩ Recent Entries (Last 5):**
{entries_text}

**üéØ Amazing Progress!** You've been consistently documenting your recovery journey.

**üí° Keep Going:**
‚Ä¢ Continue writing regularly untuk build rich data
‚Ä¢ Notice patterns dalam entries untuk insights
‚Ä¢ Use entries untuk reflect on growth over time

Great work maintaining your journaling habit! üí™‚ú®
            """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.back_to_main(),
            parse_mode='Markdown'
        )
    
    async def _mood_analysis(self, query, context):
        """Handle mood analysis"""
        message = """
üéØ **Analisis Mood**

**Advanced Feature Coming Soon!** üìä

Fitur analisis mood akan memberikan insights mendalam tentang emotional patterns Anda:

**üìà Mood Analytics akan include:**
‚Ä¢ **Mood Trends** - Grafik mood dari waktu ke waktu
‚Ä¢ **Pattern Recognition** - Identify recurring mood patterns
‚Ä¢ **Trigger Correlation** - Connection antara events dan mood changes
‚Ä¢ **Weekly/Monthly Reports** - Comprehensive mood summaries
‚Ä¢ **Improvement Suggestions** - Personalized tips based pada patterns
‚Ä¢ **Mood Forecasting** - Predict challenging periods

**üé® Visualization Features:**
‚Ä¢ Color-coded mood calendar
‚Ä¢ Trend lines dan charts
‚Ä¢ Mood distribution graphs
‚Ä¢ Correlation matrices

**üîç Current Alternatives:**
‚Ä¢ Use daily check-in untuk track mood harian
‚Ä¢ Note mood dalam journal entries
‚Ä¢ Observe personal patterns manually
‚Ä¢ Use emergency mode saat mood rendah

**üí° Self-Analysis Tips:**
‚Ä¢ Track mood consistently every day
‚Ä¢ Note external factors yang influence mood
‚Ä¢ Identify time patterns (morning vs evening mood)
‚Ä¢ Connect mood dengan sleep, exercise, activities

Continue dengan daily check-ins untuk build data yang berguna untuk future analysis!
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.back_to_main(),
            parse_mode='Markdown'
        )
    
    async def _trigger_analysis(self, query, context):
        """Handle trigger analysis"""
        message = """
üîç **Analisis Trigger**

**Smart Trigger Detection Coming Soon!** üéØ

Fitur ini akan help identify dan analyze triggers dalam recovery journey:

**üß† Trigger Analysis akan include:**
‚Ä¢ **Automatic Trigger Detection** - AI-powered identification dari journal entries
‚Ä¢ **Trigger Categories** - Emotional, situational, social, environmental triggers
‚Ä¢ **Risk Assessment** - Severity rating untuk different triggers
‚Ä¢ **Coping Strategy Matching** - Personalized tips untuk each trigger type
‚Ä¢ **Prevention Planning** - Proactive strategies untuk anticipated triggers
‚Ä¢ **Success Tracking** - Monitor progress dalam managing triggers

**üìä Analysis Features:**
‚Ä¢ Trigger frequency charts
‚Ä¢ Time-based trigger patterns
‚Ä¢ Emotion-trigger correlations
‚Ä¢ Success rate dalam handling triggers

**üõ†Ô∏è Current Tools Available:**
‚Ä¢ **Emergency Mode** - Immediate support saat trigger muncul
‚Ä¢ **Coping Tips** - Strategies untuk manage urges
‚Ä¢ **Daily Check-in** - Monitor emotional state
‚Ä¢ **Journal Writing** - Document trigger experiences

**üí™ Manual Trigger Awareness:**
‚Ä¢ Note situasi yang challenging dalam journal
‚Ä¢ Use emergency mode immediately saat urge muncul
‚Ä¢ Practice coping strategies regularly
‚Ä¢ Identify patterns dalam timing dan circumstances

**üéØ Build Trigger Awareness Now:**
1. Document trigger situations dalam journal
2. Use emergency mode untuk immediate help
3. Practice mindfulness untuk early detection
4. Build strong coping strategy toolkit

Emergency mode tersedia 24/7 untuk immediate trigger support!
        """
        
        await query.edit_message_text(
            message,
            reply_markup=BotKeyboards.journal_menu(),
            parse_mode='Markdown'
        )
    
    async def _journal_save_callback(self, query, context):
        """Handle journal save button callback"""
        user_info = get_user_info(query.from_user)
        user = self.user_service.get_or_create_user(**user_info)
        
        # Get journal text from context
        journal_text = context.user_data.get('journal_text')
        
        if not journal_text:
            app_logger.error(f"‚ùå No journal text found for user {user.telegram_id}")
            await query.edit_message_text(
                "‚ùå **Error: No journal text found**\n\n"
                "Please start again with journal menu.",
                reply_markup=BotKeyboards.journal_menu()
            )
            context.user_data.clear()
            return
        
        try:
            # Save to database using JournalService
            success = self.journal_service.create_journal_entry(
                telegram_id=user.telegram_id,
                entry_text=journal_text
            )
            
            if not success:
                app_logger.error(f"‚ùå Failed to save journal entry for user {user.telegram_id}")
                await query.edit_message_text(
                    "‚ùå **Error menyimpan journal entry**\n\n"
                    "Maaf, terjadi error saat menyimpan ke database.",
                    reply_markup=BotKeyboards.journal_menu()
                )
                return
            
            # Calculate stats
            from datetime import datetime
            timestamp = datetime.now().strftime("%d/%m/%Y %H:%M")
            word_count = len(journal_text.split())
            char_count = len(journal_text)
            
            # Get user's total entries count
            total_entries = self.journal_service.get_entry_count(user.telegram_id)
            
            # Clear the state
            context.user_data.clear()
            
            # Log successful save
            app_logger.info(f"‚úÖ Journal entry saved for user {user.telegram_id}: entry #{total_entries}")
            
            # Send success confirmation
            success_message = f"""
üéâ **Journal Entry Berhasil Disimpan!**

**üìÖ Detail Penyimpanan:**
‚Ä¢ **Timestamp**: {timestamp}
‚Ä¢ **Statistik**: {word_count} kata, {char_count} karakter
‚Ä¢ **Entry ke**: #{total_entries}
‚Ä¢ **Status**: ‚úÖ Tersimpan dalam database

**üìä Progress Kamu:**
‚Ä¢ **Total entries**: {total_entries} journal entries
‚Ä¢ **Konsistensi**: Excellent work maintaining journaling habit!

**üí° Benefits yang kamu dapatkan:**
‚Ä¢ **Self-awareness** - Better understanding of thoughts dan feelings
‚Ä¢ **Progress tracking** - Documented recovery journey
‚Ä¢ **Emotional processing** - Healthy outlet untuk feelings
‚Ä¢ **Pattern recognition** - Data untuk identify triggers dan growth

**üèÜ Achievement Unlocked**: {total_entries} journal entries completed! üí™‚ú®
            """
            
            await query.edit_message_text(
                success_message, 
                reply_markup=BotKeyboards.journal_menu(),
                parse_mode='Markdown'
            )
            
        except Exception as e:
            app_logger.error(f"üí• Exception saving journal entry for user {user.telegram_id}: {e}")
            await query.edit_message_text(
                "‚ùå **Error menyimpan journal entry**\n\n"
                "Maaf, terjadi error teknis.",
                reply_markup=BotKeyboards.journal_menu()
            )
            context.user_data.clear()
    
    async def _journal_cancel_callback(self, query, context):
        """Handle journal cancel button callback"""
        user_info = get_user_info(query.from_user)
        app_logger.info(f"üö´ Journal entry canceled by user {user_info['telegram_id']}")
        
        # Clear state
        context.user_data.clear()
        
        await query.edit_message_text(
            "üö´ **Journal Entry Dibatalkan**\n\n"
            "Entry tidak disimpan. Kamu bisa mulai menulis journal lagi kapan saja.",
            reply_markup=BotKeyboards.journal_menu(),
            parse_mode='Markdown'
        )
    
    async def _journal_edit_callback(self, query, context):
        """Handle journal edit button callback"""
        user_info = get_user_info(query.from_user)
        app_logger.info(f"‚úèÔ∏è Journal entry edit requested by user {user_info['telegram_id']}")
        
        # Reset to input mode
        context.user_data['state'] = 'input_journal'
        context.user_data['journal_step'] = 'waiting_for_text'
        context.user_data.pop('journal_text', None)  # Remove stored text
        
        await query.edit_message_text(
            "‚úèÔ∏è **Edit Journal Entry**\n\n"
            "Silakan ketik ulang journal entry kamu. Entry sebelumnya sudah dihapus.\n\n"
            "**‚å®Ô∏è Ketik journal entry baru:**",
            parse_mode='Markdown'
        )
